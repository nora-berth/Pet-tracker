name: Deploy E2E Allure Report to GitHub Pages

on:
  workflow_run:
    workflows: ["E2E Tests"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Generate and Deploy Allure Report
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' || github.event_name == 'workflow_dispatch' }}

    permissions:
      pages: write
      id-token: write
      contents: read
      actions: read

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    concurrency:
      group: "pages"
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Allure results artifact
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let runId;
            if (context.eventName === 'workflow_run') {
              runId = context.payload.workflow_run.id;
            } else {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'e2e-tests.yml',
                branch: 'main',
                per_page: 1,
              });
              runId = runs.data.workflow_runs[0].id;
            }

            console.log(`Downloading allure-results-e2e from run ${runId}`);

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            const artifact = artifacts.data.artifacts.find(a => a.name === 'allure-results-e2e');
            if (!artifact) {
              core.setFailed('allure-results-e2e artifact not found in E2E run');
              return;
            }

            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: artifact.id,
              archive_format: 'zip',
            });

            fs.writeFileSync('allure-results.zip', Buffer.from(download.data));
            console.log('Artifact downloaded successfully');

      - name: Extract Allure results
        run: |
          mkdir -p allure-results
          unzip -q allure-results.zip -d allure-results
          echo "Results extracted: $(ls allure-results | wc -l) files"

      - name: Fetch Allure history from previous deployment
        run: |
          mkdir -p allure-results/history
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          echo "Fetching history from $PAGES_URL/history/"
          for file in history.json history-trend.json categories-trend.json duration-trend.json retry-trend.json; do
            curl -sf "$PAGES_URL/history/$file" -o "allure-results/history/$file" && \
              echo "  Fetched $file" || \
              echo "  $file not found (will be created on first run)"
          done

      - name: Set up Java (for Allure CLI)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Allure CLI
        run: |
          ALLURE_VERSION="2.25.0"
          wget -q "https://github.com/allure-framework/allure2/releases/download/${ALLURE_VERSION}/allure-${ALLURE_VERSION}.tgz"
          tar -zxf "allure-${ALLURE_VERSION}.tgz"
          sudo mv "allure-${ALLURE_VERSION}" /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          echo "Allure $(allure --version) installed"

      - name: Generate Allure report
        run: |
          allure generate allure-results --clean -o allure-report
          echo "Report generated: $(du -sh allure-report | cut -f1)"

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
